<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versus Revise - Pro Analyzer v3.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .drop-zone { border: 2px dashed #334155; transition: 0.3s; }
        .drop-zone.dragover { border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .bar-bg { background: #334155; height: 12px; border-radius: 6px; overflow: hidden; }
        .bar-fill { background: linear-gradient(90deg, #38bdf8, #818cf8); height: 100%; transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); width: 0%; }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">

    <header class="w-full max-w-md mb-6 text-center">
        <h1 class="text-2xl font-bold text-sky-400 tracking-widest uppercase">Versus Revise</h1>
        <p class="text-[10px] text-slate-500 font-mono italic">STATISTICAL WEIGHTING ENGINE v3.5</p>
    </header>

    <main class="w-full max-w-md space-y-4">
        <div class="glass p-4 rounded-2xl">
            <input type="password" id="api-key" value="AIzaSyClYhUVGiryRB5d0YGRzp3ll6ZJIcvJWa0" placeholder="Google API Key" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-xs text-sky-300">
        </div>

        <div id="drop-zone" class="drop-zone glass rounded-3xl p-8 text-center cursor-pointer">
            <p class="text-sm font-bold text-slate-200">ユニメモをアップロード</p>
            <p id="file-name" class="text-[10px] font-mono italic text-slate-500">Waiting for image...</p>
            <input type="file" id="file-input" class="hidden" accept="image/*">
        </div>

        <div id="status-card" class="hidden glass p-4 rounded-xl border-l-4 border-sky-500">
            <div id="status-text" class="text-xs font-mono text-sky-400 text-center uppercase tracking-widest">Processing...</div>
        </div>

        <div class="glass rounded-3xl p-6 shadow-2xl space-y-6">
            <div class="flex justify-between items-end border-b border-slate-700 pb-2">
                <span class="text-xs text-slate-400 font-bold uppercase tracking-tighter">Setting Estimation</span>
                <span id="final-label" class="text-[10px] text-sky-500 font-mono">STANDBY</span>
            </div>
            
            <div id="results-container" class="space-y-6">
                <div id="row-1">
                    <div class="flex justify-between text-sm font-bold mb-1"><span>設定 1</span><span id="pct-1">-- %</span></div>
                    <div class="bar-bg"><div id="bar-1" class="bar-fill"></div></div>
                </div>
                <div id="row-2">
                    <div class="flex justify-between text-sm font-bold mb-1"><span>設定 2</span><span id="pct-2">-- %</span></div>
                    <div class="bar-bg"><div id="bar-2" class="bar-fill"></div></div>
                </div>
                <div id="row-5">
                    <div class="flex justify-between text-sm font-bold mb-1"><span>設定 5</span><span id="pct-5">-- %</span></div>
                    <div class="bar-bg"><div id="bar-5" class="bar-fill"></div></div>
                </div>
                <div id="row-6">
                    <div class="flex justify-between text-sm font-bold mb-1"><span>設定 6</span><span id="pct-6">-- %</span></div>
                    <div class="bar-bg"><div id="bar-6" class="bar-fill"></div></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const MASTER = {
            bonus: { 1:{bb:350.4, rb:438}, 2:{bb:334.3, rb:411.7}, 5:{bb:318.1, rb:378.8}, 6:{bb:297.8, rb:354.2} },
            normal: { 1:{ba:10.9, sa:74.5, ca:119.2, cb:56.2}, 2:{ba:10.7, sa:70.6, ca:118.9, cb:57.7}, 5:{ba:10.5, sa:72.5, ca:118.9, cb:53.1}, 6:{ba:10.2, sa:68.8, ca:118.9, cb:54.4} },
            rt: { 1:{vc:5.0, vg:10.1}, 2:{vc:4.9, vg:9.4}, 5:{vc:4.6, vg:8.7}, 6:{vc:4.5, vg:8.1} },
            bbIn: { 1:{bl:1.1, cbs:11.1, cbh:256, mc:16384}, 2:{bl:1.14, cbs:8.9, cbh:128, mc:16384}, 5:{bl:1.1, cbs:11.1, cbh:256, mc:16384}, 6:{bl:1.14, cbs:8.9, cbh:128, mc:897.8} },
            rbIn: { 1:{h:100000}, 2:{h:100000}, 5:{h:376.6}, 6:{h:376.6} }
        };

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const statusText = document.getElementById('status-text');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFile(e.target.files[0]);

        async function handleFile(file) {
            const API_KEY = document.getElementById('api-key').value;
            if (!file || !API_KEY) return;
            document.getElementById('file-name').innerText = file.name;
            document.getElementById('status-card').classList.remove('hidden');
            statusText.innerText = 'Analyzing Image...';

            try {
                const base64 = await toBase64(file);
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{ image: { content: base64.split(',')[1] }, features: [{ type: 'TEXT_DETECTION' }] }]
                    })
                });
                const json = await response.json();
                const text = json.responses[0]?.fullTextAnnotation?.text || "";
                runBayes(extract(text));
            } catch (err) { statusText.innerText = 'Error: ' + err.message; }
        }

        function extract(text) {
            const clean = text.replace(/[lI]/g, '1').replace(/\s/g, '');
            const find = (re) => {
                const m = clean.match(re);
                return m ? parseFloat(m[1].replace(/,/g, '')) : null;
            };
            const games = find(/総プレイ数([\d,.]+)/) || 1000;
            return {
                games,
                data: {
                    bonus: { bb: find(/総BB.*?1\/([\d,.]+)/), rb: find(/RB.*?1\/([\d,.]+)/) },
                    normal: { ba: find(/ベルA.*?1\/([\d,.]+)/), sa: find(/スイカA.*?1\/([\d,.]+)/), ca: find(/チェリーA.*?1\/([\d,.]+)/), cb: find(/チェリーB.*?1\/([\d,.]+)/) },
                    rt: { vc: find(/VSチャンス中はずれ.*?1\/([\d,.]+)/), vg: find(/VSGAME中はずれ.*?1\/([\d,.]+)/) },
                    bbIn: { bl: find(/BB中詳細.*?ベル.*?1\/([\d,.]+)/), cbs: find(/チェリー＋ベル揃い.*?1\/([\d,.]+)/), cbh: find(/チェリー＋ベルはずれ.*?1\/([\d,.]+)/), mc: find(/中段チェリー.*?1\/([\d,.]+)/) || 16384 },
                    rbIn: { h: find(/RB中詳細.*?はずれ.*?1\/([\d,.]+)/) || 100000 }
                }
            };
        }

        function runBayes(input) {
            const { games, data } = input;
            let logScores = { 1: Math.log(0.25), 2: Math.log(0.25), 5: Math.log(0.25), 6: Math.log(0.25) };
            const settings = [1, 2, 5, 6];

            Object.keys(MASTER).forEach(cat => {
                Object.keys(MASTER[cat][1]).forEach(key => {
                    const obs = data[cat][key];
                    if (!obs) return;

                    settings.forEach(s => {
                        const target = MASTER[cat][s][key];
                        // 確率密度関数に近い重み付け
                        // 試行回数 (games/target) が多いほど、わずかな差が対数尤度に大きく響く
                        const expectedRate = 1 / target;
                        const actualRate = 1 / obs;
                        const trials = (cat === 'normal' || cat === 'bonus') ? games : (games * 0.1); // RT等は推測値で減衰
                        
                        logScores[s] -= Math.pow(actualRate - expectedRate, 2) * trials * 10000;
                    });
                });
            });

            const maxLog = Math.max(...Object.values(logScores));
            let sum = 0;
            let finalProbs = {};
            settings.forEach(s => {
                finalProbs[s] = Math.exp(logScores[s] - maxLog);
                sum += finalProbs[s];
            });
            settings.forEach(s => finalProbs[s] /= sum);

            updateUI(finalProbs);
            statusText.innerText = 'Analysis Complete';
        }

        function updateUI(p) {
            [1, 2, 5, 6].forEach(s => {
                const v = Math.round(p[s] * 100);
                document.getElementById(`pct-${s}`).innerText = `${v} %`;
                document.getElementById(`bar-${s}`).style.width = `${v}%`;
            });
        }

        const toBase64 = f => new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result); r.onerror = e => rej(e);
        });
    </script>
</body>
</html>