<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versus Revise - Pro Analyzer v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .drop-zone { border: 2px dashed #334155; min-height: 140px; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .drop-zone.dragover { border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .bar-bg { background: #1e293b; height: 14px; border-radius: 7px; overflow: hidden; }
        .bar-fill { background: linear-gradient(90deg, #38bdf8, #818cf8); height: 100%; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1); width: 0%; }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">

    <header class="w-full max-w-md my-6 text-center">
        <h1 class="text-3xl font-black text-sky-400 tracking-tighter uppercase">Versus Revise</h1>
        <p class="text-[10px] text-slate-500 font-mono tracking-[0.3em]">SECURE STORAGE ENGINE v4.0</p>
    </header>

    <main class="w-full max-w-md space-y-4">
        
        <div id="key-section" class="glass p-4 rounded-2xl border-l-4 border-orange-500">
            <label class="text-[10px] text-slate-400 font-bold block mb-2 uppercase tracking-widest">API Key Setup (Browser Only)</label>
            <div class="flex gap-2">
                <input type="password" id="api-key-input" placeholder="AIza..." class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-sky-300">
                <button onclick="saveKey()" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded text-[10px] font-bold transition">SAVE</button>
            </div>
            <p id="key-status" class="text-[9px] text-slate-500 mt-2 italic font-mono uppercase text-center"></p>
        </div>

        <div id="drop-zone" class="drop-zone glass rounded-3xl cursor-pointer shadow-xl border-2 border-dashed border-slate-700 hover:border-sky-500 transition-all">
            <div class="text-center">
                <p class="text-xs font-bold text-slate-300">ユニメモ画像をドロップ</p>
                <p id="file-name" class="text-[10px] font-mono text-sky-500 mt-1 uppercase tracking-widest">Ready</p>
            </div>
            <input type="file" id="file-input" class="hidden" accept="image/*">
        </div>

        <div class="glass rounded-[2rem] p-8 shadow-2xl space-y-8">
            <div class="flex justify-between items-center border-b border-slate-700/50 pb-4">
                <span class="text-[11px] text-slate-400 font-bold uppercase tracking-widest">Estimation Result</span>
                <span id="final-label" class="px-3 py-1 rounded bg-sky-950 text-sky-400 text-[10px] font-mono font-bold">STANDBY</span>
            </div>
            
            <div class="space-y-7">
                <div id="row-1">
                    <div class="flex justify-between text-xs font-bold mb-2 uppercase tracking-tighter"><span>設定 1</span><span id="pct-1" class="text-sky-400 text-sm">--%</span></div>
                    <div class="bar-bg"><div id="bar-1" class="bar-fill"></div></div>
                </div>
                <div id="row-2">
                    <div class="flex justify-between text-xs font-bold mb-2 uppercase tracking-tighter"><span>設定 2</span><span id="pct-2" class="text-sky-400 text-sm">--%</span></div>
                    <div class="bar-bg"><div id="bar-2" class="bar-fill"></div></div>
                </div>
                <div id="row-5">
                    <div class="flex justify-between text-xs font-bold mb-2 uppercase tracking-tighter"><span>設定 5</span><span id="pct-5" class="text-sky-400 text-sm">--%</span></div>
                    <div class="bar-bg"><div id="bar-5" class="bar-fill"></div></div>
                </div>
                <div id="row-6">
                    <div class="flex justify-between text-xs font-bold mb-2 uppercase tracking-tighter"><span>設定 6</span><span id="pct-6" class="text-sky-400 text-sm">--%</span></div>
                    <div class="bar-bg"><div id="bar-6" class="bar-fill"></div></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const MASTER = {
            bonus: { 1:{bb:350.4, rb:438}, 2:{bb:334.3, rb:411.7}, 5:{bb:318.1, rb:378.8}, 6:{bb:297.8, rb:354.2} },
            normal: { 1:{ba:10.9, sa:74.5, ca:119.2, cb:56.2}, 2:{ba:10.7, sa:70.6, ca:118.9, cb:57.7}, 5:{ba:10.5, sa:72.5, ca:118.9, cb:53.1}, 6:{ba:10.2, sa:68.8, ca:118.9, cb:54.4} },
            rt: { 1:{vc:5.0, vg:10.1}, 2:{vc:4.9, vg:9.4}, 5:{vc:4.6, vg:8.7}, 6:{vc:4.5, vg:8.1} },
            bbIn: { 1:{bl:1.1, cbs:11.1, cbh:256, mc:16384}, 2:{bl:1.14, cbs:8.9, cbh:128, mc:16384}, 5:{bl:1.1, cbs:11.1, cbh:256, mc:16384}, 6:{bl:1.14, cbs:8.9, cbh:128, mc:897.8} },
            rbIn: { 1:{h:100000}, 2:{h:100000}, 5:{h:376.6}, 6:{h:376.6} }
        };

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        // キーの初期読み込み
        window.onload = () => {
            if(localStorage.getItem('versus_api_key')) {
                document.getElementById('key-status').innerText = 'KEY ALREADY STORED';
                document.getElementById('key-status').classList.replace('text-slate-500', 'text-sky-500');
            }
        };

        function saveKey() {
            const val = document.getElementById('api-key-input').value;
            if(!val) return alert("Keyを入力してください");
            localStorage.setItem('versus_api_key', val);
            document.getElementById('key-status').innerText = 'KEY SAVED SUCCESSFULLY';
            document.getElementById('key-status').classList.replace('text-slate-500', 'text-sky-500');
            alert("ブラウザに保存しました。GitHub上のソースには鍵は含まれません。");
        }

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = e => handleFile(e.target.files[0]);

        async function handleFile(file) {
            const key = localStorage.getItem('versus_api_key');
            if(!key) return alert("先にSAVEボタンでキーを保存してください");
            if (!file) return;
            document.getElementById('file-name').innerText = file.name;
            document.getElementById('final-label').innerText = 'ANALYZING...';

            try {
                const base64 = await toBase64(file);
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        requests: [{ image: { content: base64.split(',')[1] }, features: [{ type: 'TEXT_DETECTION' }] }]
                    })
                });
                const json = await response.json();
                const text = json.responses[0]?.fullTextAnnotation?.text || "";
                processAnalysis(extract(text));
            } catch (err) { alert(err.message); }
        }

        function extract(text) {
            const clean = text.replace(/[lI]/g, '1').replace(/\s/g, '');
            const find = (re) => {
                const m = clean.match(re);
                return m ? parseFloat(m[1].replace(/,/g, '')) : null;
            };
            return {
                games: find(/総プレイ数([\d,.]+)/) || 1000,
                data: {
                    bonus: { bb: find(/総BB.*?1\/([\d,.]+)/), rb: find(/RB.*?1\/([\d,.]+)/) },
                    normal: { ba: find(/ベルA.*?1\/([\d,.]+)/), sa: find(/スイカA.*?1\/([\d,.]+)/), ca: find(/チェリーA.*?1\/([\d,.]+)/), cb: find(/チェリーB.*?1\/([\d,.]+)/) },
                    rt: { vc: find(/VSチャンス中はずれ.*?1\/([\d,.]+)/), vg: find(/VSGAME中はずれ.*?1\/([\d,.]+)/) },
                    bbIn: { bl: find(/BB中詳細.*?ベル.*?1\/([\d,.]+)/), cbs: find(/チェリー＋ベル揃い.*?1\/([\d,.]+)/), cbh: find(/チェリー＋ベルはずれ.*?1\/([\d,.]+)/), mc: find(/中段チェリー.*?1\/([\d,.]+)/) || 16384 },
                    rbIn: { h: find(/RB中詳細.*?はずれ.*?1\/([\d,.]+)/) || 100000 }
                }
            };
        }

        function processAnalysis(input) {
            const { games, data } = input;
            let logScores = { 1: 0, 2: 0, 5: 0, 6: 0 };
            const settings = [1, 2, 5, 6];

            Object.keys(MASTER).forEach(cat => {
                Object.keys(MASTER[cat][1]).forEach(key => {
                    const obs = data[cat][key];
                    if (!obs) return;
                    settings.forEach(s => {
                        const target = MASTER[cat][s][key];
                        const trials = (cat === 'normal' || cat === 'bonus') ? games : (games * 0.1);
                        // 収束力を考慮した統計的ペナルティ計算
                        logScores[s] -= Math.pow((1/obs) - (1/target), 2) * trials * 10000;
                    });
                });
            });

            const maxLog = Math.max(...Object.values(logScores));
            let probs = {};
            let sum = 0;
            settings.forEach(s => {
                probs[s] = Math.exp(logScores[s] - maxLog);
                sum += probs[s];
            });

            settings.forEach(s => {
                const final = (probs[s] / sum);
                const pct = Math.round(final * 100);
                document.getElementById(`pct-${s}`).innerText = pct + '%';
                document.getElementById(`bar-${s}`).style.width = pct + '%';
            });
            document.getElementById('final-label').innerText = 'COMPLETE';
        }

        const toBase64 = f => new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result); r.onerror = e => rej(e);
        });
    </script>
</body>
</html>