<script>
    function extractData(json) {
        logArea.innerHTML = "【座標同期・狙撃ログ】\n";
        const data = {};
        const annotations = json.responses[0].textAnnotations;
        if (!annotations) return {};

        // 1. すべての単語を「行(Y座標)」ごとにグループ化する
        const lines = [];
        annotations.slice(1).forEach(ann => {
            const y = ann.boundingPoly.vertices[0].y;
            const text = ann.description;
            // 誤差15ピクセル以内なら同じ行とみなす
            let line = lines.find(l => Math.abs(l.y - y) < 15);
            if (!line) {
                line = { y: y, words: [] };
                lines.push(line);
            }
            line.words.push({ text: text, x: ann.boundingPoly.vertices[0].x });
        });

        // 2. 各ターゲットを「同じ行」の中から探し出す
        TARGET_MAP.forEach(t => {
            let foundVal = 0;
            // 全ての行を走査
            for (let line of lines) {
                const hasLabel = line.words.some(w => t.key.test(w.text));
                if (hasLabel) {
                    // 同じ行にある「1/x」の形式の言葉を探す
                    const probWord = line.words.find(w => /[0-9!lI|]\//.test(w.text) || /\/[0-9]/.test(w.text));
                    if (probWord) {
                        const m = probWord.text.match(/[0-9.]+/);
                        if (m) foundVal = parseFloat(m[0]);
                        break;
                    }
                }
            }
            
            data[t.id] = foundVal;
            const display = t.special ? (foundVal > 0 ? "発生！" : "未検出") : `1/${foundVal.toFixed(1)}`;
            log(`[同期済] ${t.label} → ${display}`);
        });
        return data;
    }
</script>