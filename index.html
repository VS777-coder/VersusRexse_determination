<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Versus Revise - Pro Edition v5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: #f8fafc; font-family: sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.05); }
        .bar-fill { height: 100%; transition: width 1s ease-out; }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">
    <header class="w-full max-w-md my-6 text-center">
        <h1 class="text-2xl font-black italic">VERSUS <span class="text-sky-500">REVISE</span></h1>
        <p class="text-[10px] text-slate-500 font-mono tracking-widest uppercase">Logic Transferred Edition</p>
    </header>

    <main class="w-full max-w-md space-y-4">
        <div class="glass p-4 rounded-xl">
            <input type="password" id="api-key" placeholder="Google Vision API Key" class="w-full bg-black/40 border border-slate-800 rounded p-2 text-xs text-sky-400">
            <button onclick="localStorage.setItem('vs_key', document.getElementById('api-key').value);alert('Saved')" class="w-full mt-2 bg-slate-800 py-1 rounded text-[10px] font-bold">SET KEY</button>
        </div>

        <div id="drop-zone" class="glass rounded-2xl p-8 border-2 border-dashed border-slate-700 hover:border-sky-500 text-center cursor-pointer">
            <p class="text-xs text-slate-400 font-bold uppercase">ここに画像をドロップ</p>
            <input type="file" id="file-input" class="hidden" accept="image/*">
        </div>

        <div class="glass rounded-3xl p-6 space-y-4">
            <div id="status" class="text-[10px] text-slate-500 font-mono uppercase tracking-widest text-center italic">Waiting...</div>
            <div id="results" class="space-y-5">
                <div id="res-1">
                    <div class="flex justify-between text-[11px] font-bold mb-1"><span>SETTING 1</span><span id="p1">--%</span></div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden"><div id="b1" class="bar-fill bg-sky-500" style="width:0%"></div></div>
                </div>
                <div id="res-2">
                    <div class="flex justify-between text-[11px] font-bold mb-1"><span>SETTING 2</span><span id="p2">--%</span></div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden"><div id="b2" class="bar-fill bg-sky-500" style="width:0%"></div></div>
                </div>
                <div id="res-5">
                    <div class="flex justify-between text-[11px] font-bold mb-1"><span>SETTING 5</span><span id="p5">--%</span></div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden"><div id="b5" class="bar-fill bg-indigo-500" style="width:0%"></div></div>
                </div>
                <div id="res-6">
                    <div class="flex justify-between text-[11px] font-bold mb-1"><span>SETTING 6</span><span id="p6">--%</span></div>
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden"><div id="b6" class="bar-fill bg-pink-500" style="width:0%"></div></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SPECS = {
            1: {ba:10.9, rb:438.0, vc:5.0, vg:10.1, r1:5.5, bbC:11.1},
            2: {ba:10.7, rb:411.7, vc:4.9, vg:9.4,  r1:8.5, bbC:8.9},
            5: {ba:10.5, rb:378.8, vc:4.6, vg:8.7,  r1:5.5, bbC:11.1},
            6: {ba:10.2, rb:354.2, vc:4.5, vg:8.1,  r1:8.5, bbC:8.9}
        };

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFile(e.target.files[0]);

        async function handleFile(file) {
            const key = localStorage.getItem('vs_key');
            if(!key) return alert('No Key');
            document.getElementById('status').innerText = "Analyzing...";
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: base64 }, features: [{ type: 'TEXT_DETECTION' }] }] })
                });
                const json = await res.json();
                if(json.responses[0].fullTextAnnotation) run(json.responses[0].fullTextAnnotation.text);
            };
        }

        function run(text) {
            const clean = text.replace(/\s/g, '').replace(/[lI]/g, '1');
            const find = (re) => { const m = clean.match(re); return m ? parseFloat(m[1].replace(/,/g, '')) : null; };
            const data = {
                g: find(/総プレイ数([\d,.]+)/) || 1000,
                ba: find(/ベルA.*?1\/([\d,.]+)/),
                rb: find(/RB.*?1\/([\d,.]+)/),
                vg: find(/VSGAME中はずれ.*?1\/([\d,.]+)/),
                r1: find(/1枚役.*?1\/([\d,.]+)/),
                bbC: find(/チェリー＋ベル揃い.*?1\/([\d,.]+)/),
                rbH: find(/RB中詳細.*?はずれ.*?1\/([\d,.]+)/) || 100000
            };

            let scores = {1:1, 2:1, 5:1, 6:1};
            
            // ★【現場調整】ゲーム数に応じたベルの信頼度
            let bW = data.g < 1000 ? 0.2 : (data.g < 2000 ? 0.6 : (data.g < 4000 ? 1.1 : 3.5));
            // ★【現場調整】RB確率の絶望感を最優先
            let rbW = 3.8;

            [1,2,5,6].forEach(s => {
                const sp = SPECS[s];
                if(data.ba) scores[s] *= Math.pow(1 / (Math.abs(data.ba - sp.ba) + 0.1), bW);
                if(data.rb) scores[s] *= Math.pow(1 / (Math.abs(data.rb - sp.rb) + 0.1), rbW);
                if(data.vg) scores[s] *= Math.pow(1 / (Math.abs(data.vg - sp.vg) + 0.1), 1.8);
                if(data.r1) scores[s] *= Math.pow(1 / (Math.abs(data.r1 - sp.r1) + 0.1), 1.0);
            });

            // 確定フラグがあってもボナが悪ければ1・2を死なせない
            if(data.rbH < 1000) { scores[1]*=0.05; scores[2]*=0.05; scores[5]*=5; scores[6]*=5; }

            const total = scores[1]+scores[2]+scores[5]+scores[6];
            [1,2,5,6].forEach(s => {
                const pct = (scores[s]/total*100).toFixed(1);
                document.getElementById(`p${s}`).innerText = pct + '%';
                document.getElementById(`b${s}`).style.width = pct + '%';
            });
            document.getElementById('status').innerText = `ANALYSIS COMPLETE (${data.g}G)`;
        }
    </script>
</body>
</html>